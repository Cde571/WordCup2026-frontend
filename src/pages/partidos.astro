---
import MainLayout from "../components/layout/MainLayout.astro";

const API_BASE =
  import.meta.env.PUBLIC_API_BASE_URL ?? "http://localhost:4000";

// Filtros por query string (?phase=...&status=...)
const phaseFilter = Astro.url.searchParams.get("phase") ?? "all";
const statusFilter = Astro.url.searchParams.get("status") ?? "all";

// Llamada al backend para traer los partidos
let matches = [];
let error = null;

try {
  const res = await fetch(`${API_BASE}/api/matches`);
  if (!res.ok) throw new Error(`Error ${res.status}`);
  const data = await res.json();
  matches = data.matches ?? [];
} catch (err) {
  console.error("Error cargando partidos:", err);
  error = err.message;
}

type Team = {
  _id: string;
  name: string;
  code?: string;
  logo?: string | null;
};

type Match = {
  _id: string;
  homeTeam: Team;
  awayTeam: Team;
  homeScore?: number | null;
  awayScore?: number | null;
  matchDate: string;
  stadium?: string | null;
  group?: string | null;
  phase: string;
  status: string;
};

const allMatches = matches as Match[];

// Funciones auxiliares
function formatDate(dateStr: string) {
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return "Fecha por definir";
  return d.toLocaleDateString("es-CO", {
    weekday: "short",
    day: "2-digit",
    month: "short",
  });
}

function formatTime(dateStr: string) {
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return "";
  return d.toLocaleTimeString("es-CO", {
    hour: "2-digit",
    minute: "2-digit",
    hour12: false,
  });
}

function shortPhase(phase: string) {
  switch (phase) {
    case "Group Stage":
      return "Fase de grupos";
    case "Round of 32":
      return "32avos";
    case "Round of 16":
      return "Octavos";
    case "Quarter Finals":
      return "Cuartos";
    case "Semi Finals":
      return "Semifinal";
    case "Third Place":
      return "Tercer puesto";
    case "Final":
      return "Final";
    default:
      return phase;
  }
}

function statusLabel(status: string) {
  switch (status) {
    case "Scheduled":
      return "Programado";
    case "Live":
      return "En vivo";
    case "Finished":
      return "Finalizado";
    case "Postponed":
      return "Pospuesto";
    case "Cancelled":
      return "Cancelado";
    default:
      return status;
  }
}

function statusBadgeClass(status: string) {
  switch (status) {
    case "Live":
      return "bg-red-500/10 border-red-500/60 text-red-300";
    case "Finished":
      return "bg-emerald-500/10 border-emerald-400/70 text-emerald-200";
    case "Scheduled":
      return "bg-slate-500/10 border-slate-500/60 text-slate-200";
    case "Postponed":
      return "bg-yellow-500/10 border-yellow-400/70 text-yellow-200";
    case "Cancelled":
      return "bg-rose-500/10 border-rose-400/70 text-rose-200";
    default:
      return "bg-slate-500/10 border-slate-500/60 text-slate-200";
  }
}

// Aplicar filtros (fase, estado)
const filteredMatches = allMatches.filter((m) => {
  const phaseOk = phaseFilter === "all" || m.phase === phaseFilter;
  const statusOk = statusFilter === "all" || m.status === statusFilter;
  return phaseOk && statusOk;
});

// Agrupar por fecha (YYYY-MM-DD)
const groupedByDay = new Map<string, Match[]>();

for (const match of filteredMatches) {
  const d = new Date(match.matchDate);
  const key = Number.isNaN(d.getTime())
    ? "Por definir"
    : d.toISOString().slice(0, 10);

  if (!groupedByDay.has(key)) groupedByDay.set(key, []);
  groupedByDay.get(key)!.push(match);
}

// Ordenar d√≠as
const sortedDays = Array.from(groupedByDay.keys()).sort((a, b) => {
  if (a === "Por definir") return 1;
  if (b === "Por definir") return -1;
  return a.localeCompare(b);
});

// Estad√≠sticas r√°pidas
const totalMatches = allMatches.length;
const totalScheduled = allMatches.filter((m) => m.status === "Scheduled").length;
const totalLive = allMatches.filter((m) => m.status === "Live").length;
const totalFinished = allMatches.filter((m) => m.status === "Finished").length;
---

<MainLayout title="Partidos ‚Äì Mundial 2026">
  <section class="mt-6 max-w-6xl mx-auto space-y-8 px-4">
    <!-- CABECERA -->
    <header class="border-b border-slate-800 pb-4 mb-2 flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <p class="text-[11px] uppercase tracking-[0.18em] text-emerald-300 mb-1">
          Calendario oficial
        </p>
        <h1 class="font-bebas text-3xl md:text-4xl text-white tracking-[0.22em]">
          Partidos &amp; Predicciones
        </h1>
        <p class="text-xs md:text-sm text-slate-300 max-w-2xl mt-1">
          Consulta todos los partidos del Mundial 2026: fechas, estadios y estado
          del encuentro. Desde aqu√≠ podr√°s ir accediendo a tus predicciones
          partido a partido.
        </p>
      </div>

      <!-- RESUMEN R√ÅPIDO -->
      <div class="grid grid-cols-3 gap-2 text-center text-[11px]">
        <div class="rounded-xl bg-slate-900/80 border border-slate-700 px-3 py-2">
          <p class="text-[10px] uppercase text-slate-400 tracking-[0.14em]">
            Total
          </p>
          <p class="text-lg font-semibold text-slate-50">
            {totalMatches}
          </p>
        </div>
        <div class="rounded-xl bg-slate-900/80 border border-emerald-500/60 px-3 py-2">
          <p class="text-[10px] uppercase text-emerald-300 tracking-[0.14em]">
            Finalizados
          </p>
          <p class="text-lg font-semibold text-emerald-200">
            {totalFinished}
          </p>
        </div>
        <div class="rounded-xl bg-slate-900/80 border border-sky-500/60 px-3 py-2">
          <p class="text-[10px] uppercase text-sky-300 tracking-[0.14em]">
            Programados
          </p>
          <p class="text-lg font-semibold text-sky-200">
            {totalScheduled}
          </p>
        </div>
      </div>
    </header>

    <!-- FILTROS -->
    <section class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 bg-slate-900/50 rounded-2xl border border-slate-800 p-4">
      <!-- Filtro por fase -->
      <div class="flex flex-col gap-2">
        <span class="text-[11px] text-slate-400 uppercase tracking-[0.14em] font-semibold">
          Fase del torneo
        </span>
        <div class="flex flex-wrap gap-2">
          <a
            href="/partidos"
            class={`px-3 py-1.5 rounded-full text-[11px] font-medium border transition-all ${
              phaseFilter === "all"
                ? "bg-yellow-400 text-slate-900 border-yellow-300 shadow-lg"
                : "bg-slate-800 text-slate-200 border-slate-700 hover:border-slate-500 hover:bg-slate-700"
            }`}
          >
            Todas
          </a>
          <a
            href="/partidos?phase=Group%20Stage"
            class={`px-3 py-1.5 rounded-full text-[11px] font-medium border transition-all ${
              phaseFilter === "Group Stage"
                ? "bg-yellow-400 text-slate-900 border-yellow-300 shadow-lg"
                : "bg-slate-800 text-slate-200 border-slate-700 hover:border-slate-500 hover:bg-slate-700"
            }`}
          >
            Fase de grupos
          </a>
          <a
            href="/partidos?phase=Round%20of%2016"
            class={`px-3 py-1.5 rounded-full text-[11px] font-medium border transition-all ${
              phaseFilter === "Round of 16"
                ? "bg-yellow-400 text-slate-900 border-yellow-300 shadow-lg"
                : "bg-slate-800 text-slate-200 border-slate-700 hover:border-slate-500 hover:bg-slate-700"
            }`}
          >
            Octavos
          </a>
          <a
            href="/partidos?phase=Quarter%20Finals"
            class={`px-3 py-1.5 rounded-full text-[11px] font-medium border transition-all ${
              phaseFilter === "Quarter Finals"
                ? "bg-yellow-400 text-slate-900 border-yellow-300 shadow-lg"
                : "bg-slate-800 text-slate-200 border-slate-700 hover:border-slate-500 hover:bg-slate-700"
            }`}
          >
            Cuartos
          </a>
          <a
            href="/partidos?phase=Semi%20Finals"
            class={`px-3 py-1.5 rounded-full text-[11px] font-medium border transition-all ${
              phaseFilter === "Semi Finals"
                ? "bg-yellow-400 text-slate-900 border-yellow-300 shadow-lg"
                : "bg-slate-800 text-slate-200 border-slate-700 hover:border-slate-500 hover:bg-slate-700"
            }`}
          >
            Semifinal
          </a>
          <a
            href="/partidos?phase=Final"
            class={`px-3 py-1.5 rounded-full text-[11px] font-medium border transition-all ${
              phaseFilter === "Final"
                ? "bg-yellow-400 text-slate-900 border-yellow-300 shadow-lg"
                : "bg-slate-800 text-slate-200 border-slate-700 hover:border-slate-500 hover:bg-slate-700"
            }`}
          >
            Final
          </a>
        </div>
      </div>

      <!-- Filtro por estado -->
      <div class="flex flex-col gap-2">
        <span class="text-[11px] text-slate-400 uppercase tracking-[0.14em] font-semibold">
          Estado
        </span>
        <div class="flex flex-wrap gap-2">
          <a
            href={`/partidos${phaseFilter !== "all" ? `?phase=${encodeURIComponent(phaseFilter)}` : ""}`}
            class={`px-3 py-1.5 rounded-full text-[11px] font-medium border transition-all ${
              statusFilter === "all"
                ? "bg-slate-700 text-slate-50 border-slate-500 shadow-lg"
                : "bg-slate-800 text-slate-200 border-slate-700 hover:border-slate-500 hover:bg-slate-700"
            }`}
          >
            Todos
          </a>
          <a
            href={`/partidos?${phaseFilter !== "all" ? `phase=${encodeURIComponent(phaseFilter)}&` : ""}status=Scheduled`}
            class={`px-3 py-1.5 rounded-full text-[11px] font-medium border transition-all ${
              statusFilter === "Scheduled"
                ? "bg-sky-500 text-slate-900 border-sky-400 shadow-lg"
                : "bg-slate-800 text-slate-200 border-slate-700 hover:border-slate-500 hover:bg-slate-700"
            }`}
          >
            Programados
          </a>
          <a
            href={`/partidos?${phaseFilter !== "all" ? `phase=${encodeURIComponent(phaseFilter)}&` : ""}status=Live`}
            class={`px-3 py-1.5 rounded-full text-[11px] font-medium border transition-all ${
              statusFilter === "Live"
                ? "bg-red-500 text-white border-red-400 shadow-lg"
                : "bg-slate-800 text-slate-200 border-slate-700 hover:border-slate-500 hover:bg-slate-700"
            }`}
          >
            En vivo
          </a>
          <a
            href={`/partidos?${phaseFilter !== "all" ? `phase=${encodeURIComponent(phaseFilter)}&` : ""}status=Finished`}
            class={`px-3 py-1.5 rounded-full text-[11px] font-medium border transition-all ${
              statusFilter === "Finished"
                ? "bg-emerald-500 text-slate-900 border-emerald-400 shadow-lg"
                : "bg-slate-800 text-slate-200 border-slate-700 hover:border-slate-500 hover:bg-slate-700"
            }`}
          >
            Finalizados
          </a>
        </div>
      </div>
    </section>

    <!-- ERROR O NO HAY PARTIDOS -->
    {error ? (
      <div class="bg-red-900/20 border border-red-700/50 rounded-2xl p-6 text-center">
        <p class="text-red-300">Error al cargar los partidos: {error}</p>
      </div>
    ) : sortedDays.length === 0 ? (
      <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-8 text-center">
        <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <p class="text-slate-400">No hay partidos que coincidan con los filtros seleccionados.</p>
        <a href="/partidos" class="inline-block mt-4 px-4 py-2 bg-yellow-400 text-slate-900 rounded-xl text-sm font-semibold hover:bg-yellow-500 transition-colors">
          Ver todos los partidos
        </a>
      </div>
    ) : (
      <!-- LISTADO DE PARTIDOS AGRUPADOS POR D√çA -->
      <section class="space-y-8">
        {sortedDays.map((dayKey) => {
          const dayMatches = groupedByDay.get(dayKey)!;
          const label =
            dayKey === "Por definir"
              ? "üìÖ Fecha por definir"
              : `üìÖ ${formatDate(dayMatches[0].matchDate)}`;

          return (
            <div class="space-y-3">
              <div class="flex items-center gap-3 pb-2 border-b border-slate-800">
                <h2 class="text-sm font-bebas tracking-[0.18em] text-white uppercase">
                  {label}
                </h2>
                <span class="text-xs text-slate-500">
                  {dayMatches.length} {dayMatches.length === 1 ? "partido" : "partidos"}
                </span>
              </div>
              
              <div class="space-y-3">
                {dayMatches.map((match) => (
                  <article class="rounded-2xl bg-slate-900/80 border border-slate-800 hover:border-slate-700 hover:bg-slate-900 transition-all">
                    <div class="p-4">
                      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <!-- Columna izquierda: Equipos -->
                        <div class="flex-1 space-y-3">
                          <!-- Equipo local -->
                          <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                              <div class="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-xs font-bold text-slate-400">
                                {match.homeTeam?.code || "???"}
                              </div>
                              <span class="text-sm font-semibold text-slate-100">
                                {match.homeTeam?.name || "Por definir"}
                              </span>
                            </div>
                            {match.homeScore != null && (
                              <span class="text-2xl font-bold text-white min-w-[32px] text-center">
                                {match.homeScore}
                              </span>
                            )}
                          </div>

                          <!-- Equipo visitante -->
                          <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                              <div class="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-xs font-bold text-slate-400">
                                {match.awayTeam?.code || "???"}
                              </div>
                              <span class="text-sm font-semibold text-slate-100">
                                {match.awayTeam?.name || "Por definir"}
                              </span>
                            </div>
                            {match.awayScore != null && (
                              <span class="text-2xl font-bold text-white min-w-[32px] text-center">
                                {match.awayScore}
                              </span>
                            )}
                          </div>
                        </div>

                        <!-- Columna derecha: Info del partido -->
                        <div class="flex flex-col items-start md:items-end gap-2 min-w-[160px]">
                          {/* Hora */}
                          <div class="text-sm font-semibold text-yellow-400">
                            {formatTime(match.matchDate)}
                          </div>

                          {/* Grupo y fase */}
                          <div class="text-xs text-slate-400">
                            {match.group && <span>Grupo {match.group} ¬∑ </span>}
                            <span>{shortPhase(match.phase)}</span>
                          </div>

                          {/* Estadio */}
                          {match.stadium && (
                            <div class="text-xs text-slate-500">
                              üèüÔ∏è {match.stadium}
                            </div>
                          )}

                          {/* Estado */}
                          <span class={`inline-flex items-center gap-1.5 rounded-full border px-3 py-1 text-xs font-semibold ${statusBadgeClass(match.status)}`}>
                            {match.status === "Live" && (
                              <span class="h-2 w-2 rounded-full bg-red-400 animate-pulse" />
                            )}
                            {statusLabel(match.status)}
                          </span>
                        </div>
                      </div>
                    </div>
                  </article>
                ))}
              </div>
            </div>
          );
        })}
      </section>
    )}

    <!-- CTA para hacer predicciones -->
    <div class="bg-gradient-to-r from-blue-900/20 to-purple-900/20 rounded-2xl border border-blue-700/30 p-6 mt-8">
      <div class="flex flex-col md:flex-row items-center justify-between gap-4">
        <div class="flex-1">
          <h3 class="text-lg font-bold text-white mb-2">¬øListo para hacer tus predicciones?</h3>
          <p class="text-sm text-slate-300">
            Comienza prediciendo los resultados de la fase de grupos y gana puntos cuando comience el torneo.
          </p>
        </div>
        <a
          href="/predictions"
          class="px-6 py-3 bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-slate-900 font-bold rounded-xl transition-all transform hover:scale-105 shadow-lg"
        >
          Ir a Predicciones
        </a>
      </div>
    </div>
  </section>
</MainLayout>