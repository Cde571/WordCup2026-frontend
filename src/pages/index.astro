---
import MainLayout from "../components/layout/MainLayout.astro";
import HeroBanner from "../components/home/HeroBanner.astro";

const BACKEND_URL = import.meta.env.PUBLIC_BACKEND_URL ?? "http://localhost:4000";
---

<MainLayout title="Mundial 2026 – Predicciones y Brackets">
  <!-- HERO PRINCIPAL CON PARALLAX -->
  <HeroBanner slot="hero" />

  <!-- SECCIÓN RESUMEN DE LA EXPERIENCIA -->
  <section class="mt-10">
    <h2 class="text-xl md:text-2xl font-semibold text-white mb-4">
      Vive el Mundial como un analista de élite
    </h2>

    <div class="grid gap-4 md:grid-cols-3">
      <article class="rounded-2xl bg-slate-900/70 border border-slate-800 p-4 flex flex-col justify-between">
        <div>
          <h3 class="text-sm font-semibold text-white mb-2">
            Predicciones de fase de grupos
          </h3>
          <p class="text-xs text-slate-300 mb-3 leading-relaxed">
            Define quién será 1.º, 2.º y 3.º en cada grupo. Tus elecciones
            marcarán el camino de los cruces hacia la fase eliminatoria.
          </p>
        </div>
        <a
          href="/grupos"
          class="inline-flex items-center text-xs font-semibold text-yellow-300 hover:text-yellow-200"
        >
          Ir a predicciones de grupos →
        </a>
      </article>

      <article class="rounded-2xl bg-slate-900/70 border border-slate-800 p-4 flex flex-col justify-between">
        <div>
          <h3 class="text-sm font-semibold text-white mb-2">
            Bracket de eliminatorias
          </h3>
          <p class="text-xs text-slate-300 mb-3 leading-relaxed">
            Construye tu llave desde 16avos hasta la gran final: elige ganadores,
            sorpresas, semifinalistas, campeón y tercer puesto.
          </p>
        </div>
        <a
          href="/bracket"
          class="inline-flex items-center text-xs font-semibold text-yellow-300 hover:text-yellow-200"
        >
          Ver bracket interactivo →
        </a>
      </article>

      <article class="rounded-2xl bg-slate-900/70 border border-slate-800 p-4 flex flex-col justify-between">
        <div>
          <h3 class="text-sm font-semibold text-white mb-2">
            Puntos, ranking y gamificación
          </h3>
          <p class="text-xs text-slate-300 mb-3 leading-relaxed">
            Suma puntos por cada acierto, sube posiciones en el ranking global
            y compite en mini-ligas con tus amigos. Desbloquea insignias
            especiales a medida que avance el torneo.
          </p>
        </div>
        <a
          href="/ranking"
          class="inline-flex items-center text-xs font-semibold text-yellow-300 hover:text-yellow-200"
        >
          Consultar ranking →
        </a>
      </article>
    </div>
  </section>

  <!-- SECCIÓN ACCESO RÁPIDO A PARTIDOS Y EQUIPOS -->
  <section class="mt-10 grid gap-6 md:grid-cols-[1.3fr,1fr]">
    <div class="rounded-2xl bg-slate-900/70 border border-slate-800 p-5 h-full flex flex-col justify-between">
      <div>
        <h2 class="text-sm md:text-base font-semibold text-white mb-2">
          Predice partido a partido
        </h2>
        <p class="text-xs text-slate-300 mb-4 leading-relaxed">
          Recorre el calendario completo del Mundial, revisa qué partidos ya
          tienen pronóstico y cuáles te faltan por completar. Ajusta tus
          predicciones antes de cada jornada según el rendimiento real
          de las selecciones.
        </p>
      </div>
      <a
        href="/partidos"
        class="inline-flex items-center text-xs font-semibold text-yellow-300 hover:text-yellow-200"
      >
        Ver calendario de partidos →
      </a>
    </div>

    <div class="rounded-2xl bg-slate-900/70 border border-slate-800 p-5 h-full flex flex-col justify-between">
      <div>
        <h2 class="text-sm md:text-base font-semibold text-white mb-2">
          Explora selecciones y plantillas
        </h2>
        <p class="text-xs text-slate-300 mb-4 leading-relaxed">
          Consulta todas las selecciones clasificadas, sus jugadores clave,
          datos básicos y partidos del Mundial. La información que necesitas
          antes de confirmar tus pronósticos.
        </p>
      </div>
      <a
        href="/equipos"
        class="inline-flex items-center text-xs font-semibold text-yellow-300 hover:text-yellow-200"
      >
        Ir a selecciones →
      </a>
    </div>
  </section>

  <!-- SECCIÓN MINI RESUMEN ESTADO DEL USUARIO (CONECTADO A BACKEND) -->
  <section class="mt-10 grid gap-4 md:grid-cols-3">
    <!-- Estado -->
    <div class="rounded-2xl bg-slate-900/70 border border-slate-800 p-4">
      <h3 class="text-xs font-semibold text-slate-200 mb-2">
        Estado de tus predicciones
      </h3>

      <p id="predStatusText" class="text-[11px] text-slate-300 mb-3 leading-relaxed">
        Cargando tu progreso...
      </p>

      <div class="h-2 w-full rounded-full bg-slate-800 overflow-hidden">
        <div id="predProgressBar" class="h-full w-[0%] bg-yellow-400"></div>
      </div>

      <p id="predProgressLabel" class="mt-2 text-[11px] text-slate-400">
        Progreso: 0%
      </p>

      <p id="predPoints" class="mt-2 text-[11px] text-slate-300">
        Puntos: —
      </p>
    </div>

    <!-- Próximas -->
    <div class="rounded-2xl bg-slate-900/70 border border-slate-800 p-4">
      <h3 class="text-xs font-semibold text-slate-200 mb-2">
        Próximas funcionalidades
      </h3>
      <ul class="space-y-1.5 text-[11px] text-slate-300">
        <li>• Mini-ligas privadas con tus amigos.</li>
        <li>• Insignias por rachas de aciertos.</li>
        <li>• Estadísticas avanzadas por selección y jugador.</li>
      </ul>
    </div>

    <!-- Login -->
    <div class="rounded-2xl bg-gradient-to-br from-yellow-500/20 via-emerald-500/15 to-sky-500/20 border border-yellow-400/40 p-4">
      <h3 class="text-xs font-semibold text-white mb-2">
        Conecta tu cuenta
      </h3>

      <p id="authText" class="text-[11px] text-slate-100/90 mb-3 leading-relaxed">
        Cargando estado de sesión...
      </p>

      <a
        id="googleLoginLink"
        href={`${BACKEND_URL}/auth/google`}
        class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-yellow-400 text-slate-900 text-xs font-semibold"
      >
        Iniciar sesión con Google
      </a>

      <a
        id="profileLink"
        href="/perfil"
        class="hidden mt-2 inline-flex items-center justify-center px-4 py-2 rounded-lg bg-slate-900/70 border border-slate-700 text-slate-100 text-xs font-semibold"
      >
        Ir a mi perfil
      </a>

      <button
        id="logoutBtn"
        type="button"
        class="hidden mt-2 inline-flex items-center justify-center px-4 py-2 rounded-lg bg-slate-900/70 border border-slate-700 text-slate-100 text-xs font-semibold"
      >
        Cerrar sesión
      </button>
    </div>
  </section>

  <!-- CTA FINAL HACIA PERFIL -->
  <section class="mt-10 mb-6">
    <div class="rounded-2xl bg-gradient-to-r from-yellow-500/20 via-emerald-500/10 to-sky-500/20 border border-yellow-400/40 px-5 py-4 flex flex-col md:flex-row items-center justify-between gap-3">
      <div>
        <h2 class="text-sm font-semibold text-white mb-1">
          Revisa tu progreso y tus puntos
        </h2>
        <p class="text-xs text-slate-100/80 max-w-md leading-relaxed">
          Desde tu perfil podrás ver tus puntos acumulados, tus insignias
          y el estado de tus predicciones en grupos, bracket y partidos.
        </p>
      </div>
      <a
        href="/perfil"
        class="px-4 py-2 rounded-lg bg-yellow-400 text-slate-900 text-xs font-semibold"
      >
        Ir a mi perfil
      </a>
    </div>
  </section>

  <!-- Script: conecta con backend -->
  <script define:vars={{ BACKEND_URL }}>
    const $ = (id) => document.getElementById(id);

    async function fetchJSON(url, opts = {}) {
      const res = await fetch(url, {
        credentials: "include",
        ...opts,
      });
      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status} ${text}`.trim());
      }
      return res.json();
    }

    function setProgress(percent) {
      const safe = Math.max(0, Math.min(100, percent));
      $("predProgressBar").style.width = `${safe}%`;
      $("predProgressLabel").textContent = `Progreso: ${safe}%`;
    }

    function setLoggedOutUI() {
      $("authText").textContent = "Inicia sesión con Google para guardar y ver tus predicciones.";
      $("googleLoginLink").classList.remove("hidden");
      $("profileLink").classList.add("hidden");
      $("logoutBtn").classList.add("hidden");

      $("predStatusText").textContent = "Inicia sesión para ver tu progreso y puntos.";
      $("predPoints").textContent = "Puntos: —";
      setProgress(0);
    }

    function setLoggedInUI(u) {
      $("authText").textContent = `Sesión activa: ${u.username} (${u.email})`;
      $("googleLoginLink").classList.add("hidden");
      $("profileLink").classList.remove("hidden");
      $("logoutBtn").classList.remove("hidden");
    }

    function computeProgress(summary) {
      const groupsTotal = summary?.predictions?.groups?.total ?? 12;
      const groupsCompleted = summary?.predictions?.groups?.completed ?? 0;

      const matchesPredCount = summary?.predictions?.matches?.total ?? 0;

      // Estimación: 60% grupos + 40% partidos (solo si hay al menos 1 predicción)
      const groupsPct = groupsTotal > 0 ? (groupsCompleted / groupsTotal) * 60 : 0;
      const matchesPct = matchesPredCount > 0 ? 40 : 0;

      return Math.round(groupsPct + matchesPct);
    }

    async function loadHomeData() {
      setLoggedOutUI();

      try {
        const auth = await fetchJSON(`${BACKEND_URL}/auth/status`);
        if (!auth?.loggedIn) return;

        const u = auth.user;
        setLoggedInUI(u);

        const summary = await fetchJSON(`${BACKEND_URL}/api/predictions/summary`);

        const groupsTotal = summary?.predictions?.groups?.total ?? 12;
        const groupsCompleted = summary?.predictions?.groups?.completed ?? 0;
        const matchesPredCount = summary?.predictions?.matches?.total ?? 0;

        $("predStatusText").textContent =
          `Grupos completados: ${groupsCompleted}/${groupsTotal}. ` +
          `Predicciones de partidos: ${matchesPredCount}.`;

        const progress = computeProgress(summary);
        setProgress(progress);

        const pts = summary?.user?.totalPoints ?? u.totalPoints ?? 0;
        $("predPoints").textContent = `Puntos: ${pts}`;

        $("logoutBtn").onclick = async () => {
          try {
            await fetchJSON(`${BACKEND_URL}/logout`, { method: "POST" });
          } catch (e) {
            console.error("Logout error:", e);
          } finally {
            // Refresca UI local
            setLoggedOutUI();
          }
        };
      } catch (err) {
        console.error("Home backend error:", err);
        $("authText").textContent =
          "No se pudo conectar con el backend. Revisa que esté corriendo en " + BACKEND_URL;
        $("predStatusText").textContent =
          "No se pudo cargar tu progreso (backend offline, cookies o CORS).";
        setProgress(0);
      }
    }

    loadHomeData();
  </script>
</MainLayout>
